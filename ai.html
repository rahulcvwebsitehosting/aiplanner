<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zero-Waste AI Planner</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3/dist/coco-ssd.min.js"></script>
<style>
:root{--prime:#00c9a7;--sec:#ffd166;--danger:#ef476f;--dark:#1b1b2f;--light:#f8f9fa;--glass:rgba(255,255,255,.25);--shadow:0 8px 32px rgba(0,0,0,.15)}
*{box-sizing:border-box;font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
body{margin:0;background:linear-gradient(135deg,#00c9a7 0%,#92fe9d 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:15px}
.card{background:var(--glass);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.3);border-radius:18px;padding:25px;margin:15px auto;max-width:700px;box-shadow:var(--shadow);animation:fadeUp .6s}
@keyframes fadeUp{from{opacity:0;transform:translateY(30px)}}
h1,h2{color:var(--dark);margin-top:0}
h1{font-size:2rem;text-align:center}
label{display:block;margin:10px 0 4px;font-weight:600;color:var(--dark)}
input,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,.1);font-size:1rem}
button{width:100%;padding:14px;border:none;border-radius:10px;background:var(--prime);color:#fff;font-size:1.1rem;font-weight:700;cursor:pointer;transition:.25s}
button:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,201,167,.4)}
button:active{transform:translateY(0)}
#pickBtn{background:var(--sec);color:var(--dark)}
#status{text-align:center;font-weight:700;margin-top:10px;white-space:pre-line}
.file-input-wrapper{position:relative;overflow:hidden;display:inline-block;width:100%}
.file-input-wrapper input[type=file]{position:absolute;left:-9999px}
</style>
</head>
<body>

<div class="card">
  <h1>üåø Zero-Waste AI Planner</h1>

  <label>Event name</label>
  <input id="ename" placeholder="e.g. TechFest 2025">

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label>Expected attendees</label>
      <input type="number" id="att" min="1" value="200">
    </div>
    <div>
      <label>Meal type</label>
      <select id="meal">
        <option value="snacks">Snacks only</option>
        <option value="breakfast">Breakfast</option>
        <option value="lunch">Lunch</option>
        <option value="dinner">Dinner</option>
      </select>
    </div>
  </div>

  <label><input type="checkbox" id="oil"> Has fried food / oil</label>
  <label><input type="checkbox" id="liq"> Has liquid refreshment</label>

  <!-- AI COUNTER -->
  <div class="card" style="margin-top:15px">
    <h2>üì∏ AI Plate Counter</h2>
    <div class="file-input-wrapper">
      <button id="pickBtn" type="button">Choose photo</button>
      <input type="file" id="fileInput" accept="image/*">
    </div>
    <div id="status"></div>
  </div>

  <button id="genBtn" type="button">Generate Plan üöÄ</button>
</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
  
/* ----------  model  ---------- */
let model = null;
let modelLoaded = false;

const status = document.getElementById('status');
status.textContent = '‚è≥ Loading AI model...';

cocoSsd.load().then(m => {
  model = m;
  modelLoaded = true;
  status.textContent = '‚úÖ AI model ready!';
  console.log('Model loaded successfully');
  setTimeout(() => { status.textContent = ''; }, 2000);
}).catch(err => {
  console.error('Model loading error:', err);
  status.textContent = '‚ö†Ô∏è AI model failed to load. You can still use manual entry.';
});

/* ----------  file picker  ---------- */
const fileInput = document.getElementById('fileInput');
const pickBtn = document.getElementById('pickBtn');
const attInput = document.getElementById('att');

// Direct file input change handler
fileInput.addEventListener('change', function(e) {
  console.log('File input changed');
  const file = e.target.files[0];
  if (!file) {
    console.log('No file selected');
    return;
  }
  
  console.log('File selected:', file.name);
  
  if (!modelLoaded || !model) {
    status.textContent = '‚è≥ AI model still loading, please wait...';
    return;
  }
  
  status.textContent = 'üîÑ Analyzing image...';
  
  const img = new Image();
  img.src = URL.createObjectURL(file);
  img.onload = async function() {
    try {
      console.log('Image loaded, detecting...');
      const predictions = await model.detect(img);
      console.log('Predictions:', predictions);
      
      const people = predictions.filter(p => p.class === 'person');
      const count = people.length;
      
      if (count > 0) {
        attInput.value = count;
        status.textContent = `‚úÖ Detected ${count} people. Attendees updated!`;
      } else {
        status.textContent = `‚ùå No people found. Try another photo or enter manually.`;
      }
    } catch (err) {
      console.error('Detection error:', err);
      status.textContent = '‚ùå Error analyzing image. Please try again.';
    }
    
    // Clean up
    URL.revokeObjectURL(img.src);
  };
  
  img.onerror = function() {
    status.textContent = '‚ùå Error loading image. Please try another file.';
  };
});

// Button click handler
pickBtn.addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  console.log('Pick button clicked');
  fileInput.click();
});

/* ----------  planner  ---------- */
document.getElementById('genBtn').addEventListener('click', function(e) {
  e.preventDefault();
  const n = parseInt(attInput.value);
  const eventName = document.getElementById('ename').value || 'Your Event';
  const mealType = document.getElementById('meal').value;
  const hasOil = document.getElementById('oil').checked;
  const hasLiquid = document.getElementById('liq').checked;
  
  if (!n || n < 1) { 
    status.textContent = '‚ö†Ô∏è Please enter valid number of attendees'; 
    return; 
  }
  
  // Calculate supplies needed (with 10% buffer)
  const plates = Math.ceil(n * 1.1);
  const cups = hasLiquid ? Math.ceil(n * 1.15) : 0;
  const napkins = Math.ceil(n * 1.2);
  
  let plan = `‚úÖ Plan for "${eventName}"\n`;
  plan += `üë• Attendees: ${n}\n`;
  plan += `üçΩÔ∏è Meal: ${mealType}\n\n`;
  plan += `üì¶ Supplies Needed:\n`;
  plan += `‚Ä¢ Plates: ${plates}\n`;
  if (hasLiquid) plan += `‚Ä¢ Cups: ${cups}\n`;
  plan += `‚Ä¢ Napkins: ${napkins}\n`;
  if (hasOil) plan += `‚Ä¢ Oil disposal bags: ${Math.ceil(n/50)}\n`;
  
  status.textContent = plan;
  console.log('Plan generated');
});

console.log('Event listeners attached');

}); // End DOMContentLoaded
</script>
</body>
</html>
